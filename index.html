<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartV - Math Learning Adventure</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #FFB6C1 0%, #FFE5B4 50%, #B0E0E6 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Decorative Background Elements */
        .bg-decoration {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 200"><path fill="%2398D8C8" d="M0,100 Q300,50 600,100 T1200,100 L1200,200 L0,200 Z"/><path fill="%2367C7B3" d="M0,130 Q300,100 600,130 T1200,130 L1200,200 L0,200 Z"/></svg>') bottom center/cover no-repeat;
            pointer-events: none;
            z-index: 0;
        }
        
        .clouds {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            height: 100px;
            opacity: 0.3;
            pointer-events: none;
            z-index: 0;
        }
        
        .cloud {
            position: absolute;
            background: white;
            border-radius: 100px;
            opacity: 0.6;
            animation: float-cloud 30s infinite;
        }
        
        @keyframes float-cloud {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(50px); }
        }
        
        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }
        
        /* Playful Cards */
        .card {
            background: white;
            border-radius: 30px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15), 0 5px 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        /* Character Avatar */
        .character-big {
            font-size: 8rem;
            filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.2));
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        /* Rounded Buttons */
        .btn-round {
            background: linear-gradient(135deg, #FFD93D 0%, #FFB347 100%);
            border: none;
            border-radius: 20px;
            padding: 1.2rem 2.5rem;
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(255, 179, 71, 0.4);
            transition: all 0.3s;
            font-family: 'Fredoka', sans-serif;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .btn-round:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 30px rgba(255, 179, 71, 0.5);
        }
        
        .btn-round:active {
            transform: translateY(-2px) scale(1.02);
        }
        
        .btn-primary { background: linear-gradient(135deg, #67C7B3 0%, #4FA899 100%); box-shadow: 0 8px 20px rgba(103, 199, 179, 0.4); }
        .btn-success { background: linear-gradient(135deg, #98D8C8 0%, #67C7B3 100%); box-shadow: 0 8px 20px rgba(152, 216, 200, 0.4); }
        .btn-warning { background: linear-gradient(135deg, #FF9AA2 0%, #FF6B81 100%); box-shadow: 0 8px 20px rgba(255, 154, 162, 0.4); }
        
        /* Problem Card (like the yellow card in image) */
        .problem-card {
            background: linear-gradient(135deg, #FFE5B4 0%, #FFD98E 100%);
            border-radius: 30px;
            padding: 3rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            text-align: center;
            border: 5px solid rgba(255, 255, 255, 0.5);
        }
        
        .problem-text {
            font-size: 5rem;
            font-weight: 800;
            color: #8B6F47;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
            font-family: 'Fredoka', sans-serif;
            line-height: 1.2;
        }
        
        /* Answer Grid (like the green tiles) */
        .answer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            padding: 2rem;
        }
        
        .answer-tile {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #67C7B3 0%, #4FA899 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(103, 199, 179, 0.3);
            transition: all 0.3s;
            font-family: 'Fredoka', sans-serif;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border: 4px solid rgba(255, 255, 255, 0.3);
        }
        
        .answer-tile:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 15px 35px rgba(103, 199, 179, 0.4);
        }
        
        .answer-tile:active {
            transform: translateY(-3px) scale(1.02);
        }
        
        /* Activity Tiles */
        .activity-tile {
            background: white;
            border-radius: 25px;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 4px solid rgba(255, 255, 255, 0.5);
        }
        
        .activity-tile:hover {
            transform: translateY(-10px) rotate(2deg);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        
        .activity-icon {
            width: 100px;
            height: 100px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            margin: 0 auto 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        /* Banner (like the teal ribbon) */
        .banner {
            background: linear-gradient(135deg, #67C7B3 0%, #4FA899 100%);
            color: white;
            padding: 1.5rem 3rem;
            border-radius: 20px;
            text-align: center;
            font-size: 2rem;
            font-weight: 800;
            box-shadow: 0 10px 25px rgba(103, 199, 179, 0.3);
            margin-bottom: 2rem;
            font-family: 'Fredoka', sans-serif;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .banner::before,
        .banner::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 0;
            height: 0;
            border-style: solid;
        }
        
        .banner::before {
            left: -15px;
            border-width: 25px 15px 25px 0;
            border-color: transparent #4FA899 transparent transparent;
            transform: translateY(-50%);
        }
        
        .banner::after {
            right: -15px;
            border-width: 25px 0 25px 15px;
            border-color: transparent transparent transparent #4FA899;
            transform: translateY(-50%);
        }
        
        /* Avatar Selection */
        .avatar-select {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
        }
        
        .avatar-option {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #FFE5B4 0%, #FFD98E 100%);
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            border: 4px solid transparent;
        }
        
        .avatar-option:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        }
        
        .avatar-option.selected {
            border-color: #67C7B3;
            background: linear-gradient(135deg, #98D8C8 0%, #67C7B3 100%);
            transform: scale(1.15);
        }
        
        /* Input Fields */
        input {
            background: white;
            border: 4px solid #E8F5F2;
            border-radius: 20px;
            padding: 1.2rem 1.5rem;
            font-size: 1.3rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            outline: none;
            transition: all 0.3s;
            box-shadow: inset 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        input:focus {
            border-color: #67C7B3;
            box-shadow: 0 0 0 4px rgba(103, 199, 179, 0.2), inset 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        /* Progress Bar */
        .progress-container {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 100px;
            height: 30px;
            overflow: hidden;
            box-shadow: inset 0 3px 10px rgba(0, 0, 0, 0.1);
            border: 3px solid rgba(255, 255, 255, 0.8);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD93D 0%, #FFB347 100%);
            border-radius: 100px;
            transition: width 0.5s;
            box-shadow: 0 2px 10px rgba(255, 179, 71, 0.5);
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Stats Display */
        .stat-badge {
            background: linear-gradient(135deg, #FFE5B4 0%, #FFD98E 100%);
            border-radius: 20px;
            padding: 1rem 2rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: 800;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            border: 3px solid rgba(255, 255, 255, 0.5);
            font-family: 'Fredoka', sans-serif;
        }
        
        /* Help Button */
        .help-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #98D8C8 0%, #67C7B3 100%);
            border: none;
            color: white;
            font-size: 2rem;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(103, 199, 179, 0.4);
            transition: all 0.3s;
            font-family: 'Fredoka', sans-serif;
        }
        
        .help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(103, 199, 179, 0.5);
        }
        
        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 30px;
            padding: 3rem;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
            border: 5px solid rgba(255, 255, 255, 0.5);
        }
        
        /* Grid Layouts */
        .grid { display: grid; gap: 1.5rem; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        
        /* Flex */
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        
        /* Typography */
        h1 { font-size: 3rem; font-weight: 800; font-family: 'Fredoka', sans-serif; color: #5A4A3A; }
        h2 { font-size: 2.5rem; font-weight: 700; font-family: 'Fredoka', sans-serif; color: #5A4A3A; }
        h3 { font-size: 2rem; font-weight: 600; font-family: 'Fredoka', sans-serif; color: #5A4A3A; }
        
        /* Utility */
        .text-center { text-align: center; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-4 { margin-top: 1rem; }
        .hidden { display: none; }
        
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.8rem; }
            h3 { font-size: 1.5rem; }
            .problem-text { font-size: 3rem; }
            .answer-tile { font-size: 2rem; }
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .character-big { font-size: 5rem; }
            .stat-badge { font-size: 1.2rem; padding: 0.8rem 1.5rem; }
            .btn-round { padding: 1rem 1.5rem; font-size: 1.1rem; }
            .modal-content { width: 95%; padding: 1.5rem; max-height: 90vh; overflow-y: auto; }
            .banner { font-size: 1.5rem; padding: 1rem 1.5rem; }
            .banner::before, .banner::after { display: none; }
            .activity-icon { width: 80px; height: 80px; font-size: 3rem; }
            .activity-tile h3 { font-size: 1.3rem; }
            .flex.gap-4 { flex-direction: column; gap: 0.5rem; }
            .flex.gap-4 > * { width: 100%; }
        }
        
        @media (max-width: 480px) {
            .problem-text { font-size: 2rem; }
            .answer-grid { grid-template-columns: repeat(2, 1fr); }
            .answer-tile { font-size: 1.5rem; }
            h1 { font-size: 1.5rem; }
            .stat-badge { font-size: 1rem; padding: 0.6rem 1rem; }
        }
    </style>
</head>
<body>
    <div class="clouds">
        <div class="cloud" style="width: 100px; height: 50px; top: 20px; left: 10%;"></div>
        <div class="cloud" style="width: 150px; height: 70px; top: 50px; left: 60%;"></div>
        <div class="cloud" style="width: 120px; height: 60px; top: 30px; left: 85%;"></div>
    </div>
    <div class="bg-decoration"></div>
    
    <div id="app"></div>

    <script>
        /*
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        üéµ AUDIO SETUP INSTRUCTIONS - READ THIS FIRST!
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        To use your custom soundtracks from Freesound.org:
        
        STEP 1: Download the audio files
        ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        Visit each Freesound link and download the files:
        ‚Ä¢ Menu Music: https://freesound.org/people/Mrthenoronha/sounds/371148/
        ‚Ä¢ Game Music 1: https://freesound.org/people/Mrthenoronha/sounds/476546/
        ‚Ä¢ Game Music 2: https://freesound.org/people/Mrthenoronha/sounds/519097/
        ‚Ä¢ Game Music 3: https://freesound.org/people/Mrthenoronha/sounds/476548/
        
        STEP 2: Host the files on Netlify
        ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        1. Create a folder called "audio" in your project root
        2. Upload the downloaded files to this folder
        3. Rename them to:
           - menu-music.mp3 (or .ogg, .wav - whatever format you downloaded)
           - game-primary.mp3
           - game-secondary.mp3
           - game-tertiary.mp3
        
        STEP 3: Update the AUDIO_CONFIG below
        ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        Change the URLs in AUDIO_CONFIG to point to your hosted files:
        ‚Ä¢ If files are in /audio/ folder, use: '/audio/filename.mp3'
        ‚Ä¢ If hosted elsewhere, use full URL: 'https://yoursite.com/audio/filename.mp3'
        
        STEP 4: Deploy to Netlify
        ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        1. Push your changes to GitHub
        2. Netlify will auto-deploy
        3. Test the music!
        
        NOTE: The app includes fallback synthesized music if files aren't found.
        
        ‚ö†Ô∏è  LICENSING: Make sure to credit the creator!
           All sounds by Mrthenoronha on Freesound.org
           Licensed under Creative Commons (check each sound's license)
        
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        */
        
        // Initialize or load saved data from localStorage
        let appData = JSON.parse(localStorage.getItem('smartvData')) || {
            isSetup: false,
            adminCode: '',
            student: {
                name: '',
                avatar: 'ü¶∏',
                level: 1,
                xp: 0,
                stars: 0,
                hintsAvailable: 5,
                totalQuestionsAnswered: 0,
                totalCorrect: 0,
                difficultyPreferences: {
                    addition: 'auto',
                    subtraction: 'auto',
                    patterns: 'auto',
                    placeValue: 'auto',
                    skipCount: 'auto',
                    storySolver: 'auto',
                    moneyMaster: 'auto',
                    compareNumbers: 'auto'
                },
                skills: {
                    addition: { mastery: 0, correct: 0, total: 0, timeSpent: 0 },
                    subtraction: { mastery: 0, correct: 0, total: 0, timeSpent: 0 },
                    patterns: { mastery: 0, correct: 0, total: 0, timeSpent: 0 },
                    placeValue: { mastery: 0, correct: 0, total: 0, timeSpent: 0 },
                    skipCount: { mastery: 0, correct: 0, total: 0, timeSpent: 0 },
                    storySolver: { mastery: 0, correct: 0, total: 0, timeSpent: 0 },
                    moneyMaster: { mastery: 0, correct: 0, total: 0, timeSpent: 0 },
                    compareNumbers: { mastery: 0, correct: 0, total: 0, timeSpent: 0 }
                },
                sessions: [],
                achievements: []
            }
        };

        let state = {
            screen: appData.isSetup ? 'home' : 'setup',
            currentGame: null,
            showHint: false,
            soundEnabled: true,
            musicEnabled: true,
            gameState: {
                question: null,
                answer: '',
                score: 0,
                lives: 3,
                questionsAnswered: 0,
                correctStreak: 0,
                difficulty: 'easy',
                showExplanation: false,
                sessionStart: null,
                questionStart: null,
                mistakes: []
            }
        };

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('smartvData', JSON.stringify(appData));
        }

        // Sound System
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // ‚≠ê AUDIO CONFIGURATION - MUSIC FILES FROM GOOGLE DRIVE ‚≠ê
        const AUDIO_CONFIG = {
            // Menu/Dashboard music (plays on home, setup, settings, parent dashboard)
            menuMusic: 'https://drive.google.com/uc?export=download&id=1_aCuhCdbixwj7fBm1zQleD7GWUvaEBLz',
            
            // Game music (randomly picks one when game starts)
            gameMusic: [
                'https://drive.google.com/uc?export=download&id=1VSiCa2HMdL6X8_eBu6TWdEQHfcEUG1yZ',
                'https://drive.google.com/uc?export=download&id=1DAJEKGQ9q2OhUJi_mhnxFHGDtBsgWRzQ',
                'https://drive.google.com/uc?export=download&id=1WRbAIpP5xxrTOnw-a1WQqm967FSCe3Wr'
            ]
        };
        
        let currentMusic = null;
        let musicVolume = 0.3; // Default volume (0.0 to 1.0)

        function playBackgroundMusic(type = 'menu') {
            if (!state.musicEnabled || currentMusic) return;
            
            const musicUrl = type === 'menu' 
                ? AUDIO_CONFIG.menuMusic 
                : AUDIO_CONFIG.gameMusic[Math.floor(Math.random() * AUDIO_CONFIG.gameMusic.length)];
            
            currentMusic = new Audio(musicUrl);
            currentMusic.loop = true;
            currentMusic.volume = musicVolume;
            
            // Handle loading errors gracefully
            currentMusic.onerror = () => {
                console.warn('Music file not found - using fallback synthesized music');
                currentMusic = null;
                playFallbackMusic(type);
            };
            
            currentMusic.play().catch(err => {
                console.warn('Music playback failed:', err);
                currentMusic = null;
            });
        }

        function stopBackgroundMusic() {
            if (currentMusic) {
                currentMusic.pause();
                currentMusic.currentTime = 0;
                currentMusic = null;
            }
        }
        
        function setMusicVolume(volume) {
            musicVolume = Math.max(0, Math.min(1, volume));
            if (currentMusic) {
                currentMusic.volume = musicVolume;
            }
        }
        
        // Fallback to synthesized music if audio files not found
        function playFallbackMusic(type) {
            // Original synthesized music code as fallback
            const melody = type === 'menu' 
                ? [{freq: 440, duration: 0.4}, {freq: 523.25, duration: 0.4}, {freq: 587.33, duration: 0.4}, {freq: 440, duration: 0.4}]
                : [{freq: 523.25, duration: 0.3}, {freq: 587.33, duration: 0.3}, {freq: 659.25, duration: 0.3}, {freq: 523.25, duration: 0.3}];
            
            const gainNode = audioContext.createGain();
            gainNode.gain.value = 0.03;
            gainNode.connect(audioContext.destination);
            
            let currentTime = audioContext.currentTime;
            
            function playMelody() {
                if (!state.musicEnabled) return;
                
                melody.forEach((note) => {
                    const osc = audioContext.createOscillator();
                    osc.connect(gainNode);
                    osc.frequency.value = note.freq;
                    osc.type = 'sine';
                    
                    const startTime = currentTime;
                    osc.start(startTime);
                    osc.stop(startTime + note.duration);
                    
                    currentTime += note.duration;
                });
                
                currentMusic = setTimeout(() => {
                    currentTime = audioContext.currentTime;
                    playMelody();
                }, melody.reduce((sum, note) => sum + note.duration, 0) * 1000);
            }
            
            playMelody();
        }

        function playSound(type) {
            if (!state.soundEnabled) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'click':
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                    break;
                    
                case 'correct':
                    // Happy ascending notes
                    const notes = [523.25, 659.25, 783.99]; // C, E, G
                    notes.forEach((freq, i) => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(audioContext.destination);
                        osc.frequency.value = freq;
                        osc.type = 'sine';
                        gain.gain.setValueAtTime(0.15, audioContext.currentTime + i * 0.1);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.1 + 0.3);
                        osc.start(audioContext.currentTime + i * 0.1);
                        osc.stop(audioContext.currentTime + i * 0.1 + 0.3);
                    });
                    return; // Skip the default oscillator
                    
                case 'wrong':
                    // Sad descending notes
                    oscillator.frequency.value = 200;
                    oscillator.type = 'sawtooth';
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.4);
                    break;
                    
                case 'complete':
                    // Victory fanfare
                    const victoryNotes = [523.25, 659.25, 783.99, 1046.50]; // C, E, G, High C
                    victoryNotes.forEach((freq, i) => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(audioContext.destination);
                        osc.frequency.value = freq;
                        osc.type = 'triangle';
                        gain.gain.setValueAtTime(0.2, audioContext.currentTime + i * 0.15);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.15 + 0.5);
                        osc.start(audioContext.currentTime + i * 0.15);
                        osc.stop(audioContext.currentTime + i * 0.15 + 0.5);
                    });
                    return;
                    
                case 'hint':
                    oscillator.frequency.value = 1000;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                    break;
            }
        }

        function toggleSound() {
            state.soundEnabled = !state.soundEnabled;
            playSound('click');
            render();
        }

        function toggleMusic() {
            state.musicEnabled = !state.musicEnabled;
            if (!state.musicEnabled) {
                stopBackgroundMusic();
            } else {
                // Restart music based on current screen
                const musicType = state.screen === 'playing' ? 'game' : 'menu';
                playBackgroundMusic(musicType);
            }
            render();
        }

        // Setup Screen
        function renderSetup() {
            return `
                <div class="container" style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
                    <div class="card" style="max-width: 700px;">
                        <div class="text-center mb-6">
                            <div class="character-big">üéì</div>
                            <h1 class="mb-4">Welcome to SmartV!</h1>
                            <p style="font-size: 1.4rem; color: #7A6A5A;">Let's start your math adventure!</p>
                        </div>
                        
                        <div class="mb-6">
                            <label style="display: block; font-weight: 700; margin-bottom: 0.75rem; color: #5A4A3A; font-size: 1.3rem; font-family: 'Fredoka', sans-serif;">What's your name? ‚ú®</label>
                            <input type="text" id="studentName" placeholder="Type your name here" style="width: 100%;" />
                        </div>
                        
                        <div class="mb-6">
                            <label style="display: block; font-weight: 700; margin-bottom: 1rem; color: #5A4A3A; font-size: 1.3rem; font-family: 'Fredoka', sans-serif;">Pick your character! üé®</label>
                            <div class="avatar-select">
                                ${['ü¶∏', 'üßô', 'ü¶Ñ', 'üêâ', 'üåü', 'üöÄ'].map(emoji => `
                                    <div onclick="selectAvatar('${emoji}')" id="avatar-${emoji}" class="avatar-option">
                                        ${emoji}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="mb-6" style="background: linear-gradient(135deg, #FFE5E5 0%, #FFD0D0 100%); padding: 2rem; border-radius: 25px; border: 4px solid rgba(255, 255, 255, 0.5);">
                            <label style="display: block; font-weight: 700; margin-bottom: 0.75rem; color: #CC5555; font-size: 1.3rem; font-family: 'Fredoka', sans-serif;">üë®‚Äçüë©‚Äçüëß Parents: Set Admin Code</label>
                            <p style="color: #AA4444; margin-bottom: 1rem; font-size: 1rem; font-weight: 600;">Create a 4-digit code to view progress reports</p>
                            <input type="password" id="adminCode" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" style="width: 100%;" />
                        </div>
                        
                        <button onclick="completeSetup()" class="btn-round btn-success" style="width: 100%; font-size: 1.5rem; padding: 1.5rem;">
                            üöÄ Start Adventure!
                        </button>
                        
                        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(103, 199, 179, 0.1); border-radius: 15px; text-align: center;">
                            <p style="color: #4FA899; font-size: 0.9rem; font-weight: 600;">
                                üíæ Your progress will be saved on this device!
                            </p>
                        </div>
                        
                        <div style="margin-top: 1rem; padding: 0.8rem; background: rgba(167, 139, 250, 0.1); border-radius: 12px; text-align: center;">
                            <p style="color: #8b5cf6; font-size: 0.75rem; font-weight: 500;">
                                üéµ Music by Mrthenoronha (Freesound.org)
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        let selectedAvatar = 'ü¶∏';
        function selectAvatar(emoji) {
            playSound('click');
            selectedAvatar = emoji;
            document.querySelectorAll('[id^="avatar-"]').forEach(btn => btn.classList.remove('selected'));
            document.getElementById(`avatar-${emoji}`).classList.add('selected');
        }

        function completeSetup() {
            const name = document.getElementById('studentName').value.trim();
            const code = document.getElementById('adminCode').value.trim();
            
            if (!name) {
                playSound('wrong');
                alert('Please enter your name! üòä');
                return;
            }
            if (code.length !== 4 || !/^\d+$/.test(code)) {
                playSound('wrong');
                alert('Admin code must be 4 digits! üî¢');
                return;
            }
            
            playSound('complete');
            appData.isSetup = true;
            appData.adminCode = code;
            appData.student.name = name;
            appData.student.avatar = selectedAvatar;
            appData.student.hintsAvailable = 5;
            appData.student.difficultyPreferences = {
                addition: 'auto',
                subtraction: 'auto',
                patterns: 'auto',
                placeValue: 'auto',
                skipCount: 'auto',
                storySolver: 'auto',
                moneyMaster: 'auto',
                compareNumbers: 'auto'
            };
            saveData();
            state.screen = 'home';
            render();
        }

        // Generate problems
        function generateProblem(type, difficulty) {
            const ranges = {
                easy: { min: 1, max: 10 },
                medium: { min: 5, max: 20 },
                hard: { min: 10, max: 50 }
            };
            const range = ranges[difficulty];

            switch(type) {
                case 'addition': {
                    const a = Math.floor(Math.random() * range.max) + range.min;
                    const b = Math.floor(Math.random() * range.max) + range.min;
                    return {
                        question: `${a} + ${b}`,
                        answer: a + b,
                        type: 'addition',
                        numbers: [a, b],
                        wrongAnswers: generateWrongAnswers(a + b, 3),
                        hint: `Start at ${a}, then count up ${b} more!`,
                        visualHint: a <= 10 && b <= 10 ? `${'üéà'.repeat(a)} + ${'üéà'.repeat(b)}` : `Use your fingers to count!`
                    };
                }
                case 'subtraction': {
                    const a = Math.floor(Math.random() * range.max) + range.min + 5;
                    const b = Math.floor(Math.random() * Math.min(a, range.max)) + 1;
                    return {
                        question: `${a} - ${b}`,
                        answer: a - b,
                        type: 'subtraction',
                        numbers: [a, b],
                        wrongAnswers: generateWrongAnswers(a - b, 3),
                        hint: `Start at ${a}, count backward ${b} times!`,
                        visualHint: a <= 10 ? `${'‚≠ê'.repeat(a)} (cross out ${b})` : `Count back on your fingers!`
                    };
                }
                case 'patterns': {
                    const start = Math.floor(Math.random() * 5) + 1;
                    const step = Math.floor(Math.random() * 3) + 2;
                    const seq = [start, start + step, start + step * 2];
                    return {
                        question: `${seq.join(', ')}, __`,
                        answer: start + step * 3,
                        type: 'patterns',
                        sequence: seq,
                        step: step,
                        wrongAnswers: generateWrongAnswers(start + step * 3, 3),
                        hint: `What number do you add each time?`,
                        visualHint: `${seq[0]} ‚Üí ${seq[1]} ‚Üí ${seq[2]} ‚Üí ?`
                    };
                }
                case 'placeValue': {
                    const num = Math.floor(Math.random() * 90) + 10;
                    return {
                        question: `${Math.floor(num/10)} tens + ${num%10} ones`,
                        answer: num,
                        type: 'placeValue',
                        tens: Math.floor(num/10),
                        ones: num % 10,
                        wrongAnswers: generateWrongAnswers(num, 3),
                        hint: `Count the tens first, then add the ones!`,
                        visualHint: `How many groups of 10? Then how many extra?`
                    };
                }
                case 'skipCount': {
                    const skipBy = [2, 5, 10][Math.floor(Math.random() * 3)];
                    const start = skipBy * Math.floor(Math.random() * 3);
                    const seq = [start, start + skipBy, start + skipBy * 2];
                    return {
                        question: `Count by ${skipBy}s: ${seq.join(', ')}, __`,
                        answer: start + skipBy * 3,
                        type: 'skipCount',
                        skipBy: skipBy,
                        sequence: seq,
                        wrongAnswers: generateWrongAnswers(start + skipBy * 3, 3),
                        hint: `Keep adding ${skipBy}!`,
                        visualHint: `What comes after ${seq[2]}?`
                    };
                }
                case 'storySolver': {
                    const stories = [
                        { text: `{a} apples - {b} apples`, a: range.min + 5, b: range.min + 2, op: 'sub' },
                        { text: `{a} birds + {b} birds`, a: range.min + 3, b: range.min + 2, op: 'add' },
                        { text: `{a} toys + {b} toys`, a: range.min + 4, b: range.min + 3, op: 'add' }
                    ];
                    const story = stories[Math.floor(Math.random() * stories.length)];
                    const answer = story.op === 'add' ? story.a + story.b : story.a - story.b;
                    return {
                        question: story.text.replace('{a}', story.a).replace('{b}', story.b),
                        answer: answer,
                        type: 'storySolver',
                        wrongAnswers: generateWrongAnswers(answer, 3),
                        hint: story.op === 'add' ? `Put them together! Add the numbers!` : `Take some away! Subtract!`,
                        visualHint: `${story.a} ${story.op === 'add' ? '+' : '-'} ${story.b} = ?`
                    };
                }
                case 'moneyMaster': {
                    const coins = [1, 5, 10, 25];
                    const numCoins = Math.floor(Math.random() * 3) + 2;
                    let total = 0;
                    let coinList = [];
                    for (let i = 0; i < numCoins; i++) {
                        const coin = coins[Math.floor(Math.random() * (difficulty === 'easy' ? 2 : difficulty === 'medium' ? 3 : 4))];
                        coinList.push(coin);
                        total += coin;
                    }
                    const coinNames = coinList.map(c => c === 1 ? '1¬¢' : c === 5 ? '5¬¢' : c === 10 ? '10¬¢' : '25¬¢');
                    return {
                        question: `${coinNames.join(' + ')}`,
                        answer: total,
                        type: 'moneyMaster',
                        wrongAnswers: generateWrongAnswers(total, 3),
                        hint: `Add each coin value together!`,
                        visualHint: `${coinList.join(' + ')} = ?`
                    };
                }
                case 'compareNumbers': {
                    const a = Math.floor(Math.random() * range.max) + range.min;
                    const b = Math.floor(Math.random() * range.max) + range.min;
                    const correctSymbol = a > b ? '>' : a < b ? '<' : '=';
                    const wrongSymbols = ['>', '<', '='].filter(s => s !== correctSymbol);
                    return {
                        question: `${a} __ ${b}`,
                        answer: correctSymbol,
                        type: 'compareNumbers',
                        isSymbol: true,
                        wrongAnswers: wrongSymbols,
                        hint: `Which number is bigger?`,
                        visualHint: a > b ? `${a} is greater than ${b}` : a < b ? `${a} is less than ${b}` : `${a} equals ${b}`
                    };
                }
            }
        }

        function generateWrongAnswers(correct, count) {
            const wrong = new Set();
            while (wrong.size < count) {
                const offset = Math.floor(Math.random() * 10) - 5;
                const val = correct + offset;
                if (val !== correct && val > 0) wrong.add(val);
            }
            return Array.from(wrong);
        }

        function startGame(gameType) {
            playSound('click');
            state.currentGame = gameType;
            state.showHint = false;
            const skill = appData.student.skills[gameType];
            
            // Check difficulty preference
            let diff;
            const pref = appData.student.difficultyPreferences[gameType];
            if (pref === 'auto') {
                diff = skill.mastery < 30 ? 'easy' : skill.mastery < 70 ? 'medium' : 'hard';
            } else {
                diff = pref;
            }
            
            state.gameState = {
                question: generateProblem(gameType, diff),
                answer: '',
                score: 0,
                lives: 3,
                questionsAnswered: 0,
                correctStreak: 0,
                difficulty: diff,
                showExplanation: false,
                sessionStart: Date.now(),
                questionStart: Date.now(),
                mistakes: []
            };
            state.screen = 'playing';
            
            // Start game music
            stopBackgroundMusic();
            setTimeout(() => playBackgroundMusic('game'), 100);
            
            render();
        }

        function toggleHint() {
            if (!state.showHint && appData.student.hintsAvailable <= 0) {
                playSound('wrong');
                alert('No hints available! üí° Answer questions correctly to earn more hints!');
                return;
            }
            
            if (!state.showHint) {
                appData.student.hintsAvailable--;
                saveData();
                playSound('hint');
            } else {
                playSound('click');
            }
            
            state.showHint = !state.showHint;
            render();
        }

        function resetProgress() {
            playSound('click');
            if (confirm('Are you sure you want to reset ALL progress? This cannot be undone! üîÑ')) {
                if (confirm('Really reset everything? All stars, XP, and progress will be lost! üòÆ')) {
                    playSound('complete');
                    appData.student.level = 1;
                    appData.student.xp = 0;
                    appData.student.stars = 0;
                    appData.student.hintsAvailable = 5;
                    appData.student.totalQuestionsAnswered = 0;
                    appData.student.totalCorrect = 0;
                    appData.student.difficultyPreferences = {
                        addition: 'auto',
                        subtraction: 'auto',
                        patterns: 'auto',
                        placeValue: 'auto',
                        skipCount: 'auto',
                        storySolver: 'auto',
                        moneyMaster: 'auto',
                        compareNumbers: 'auto'
                    };
                    appData.student.skills = {
                        addition: { mastery: 0, correct: 0, total: 0, timeSpent: 0 },
                        subtraction: { mastery: 0, correct: 0, total: 0, timeSpent: 0 },
                        patterns: { mastery: 0, correct: 0, total: 0, timeSpent: 0 },
                        placeValue: { mastery: 0, correct: 0, total: 0, timeSpent: 0 },
                        skipCount: { mastery: 0, correct: 0, total: 0, timeSpent: 0 },
                        storySolver: { mastery: 0, correct: 0, total: 0, timeSpent: 0 },
                        moneyMaster: { mastery: 0, correct: 0, total: 0, timeSpent: 0 },
                        compareNumbers: { mastery: 0, correct: 0, total: 0, timeSpent: 0 }
                    };
                    appData.student.sessions = [];
                    appData.student.achievements = [];
                    saveData(); // Save reset state
                    state.screen = 'home';
                    render();
                    alert('Progress reset complete! Let\'s start fresh! üåü');
                } else {
                    playSound('wrong');
                }
            } else {
                playSound('wrong');
            }
        }

        function checkAnswer(userAnswer) {
            const isCorrect = userAnswer == state.gameState.question.answer;
            const timeSpent = Date.now() - state.gameState.questionStart;
            
            appData.student.skills[state.currentGame].total++;
            appData.student.totalQuestionsAnswered++;

            if (isCorrect) {
                playSound('correct');
                const points = state.gameState.difficulty === 'hard' ? 15 : state.gameState.difficulty === 'medium' ? 10 : 5;
                state.gameState.score += points;
                state.gameState.correctStreak++;
                state.gameState.questionsAnswered++;
                appData.student.skills[state.currentGame].correct++;
                appData.student.totalCorrect++;
                appData.student.skills[state.currentGame].timeSpent += timeSpent;
                
                // Award hint every 3 correct answers
                if (appData.student.totalCorrect % 3 === 0) {
                    appData.student.hintsAvailable++;
                }
                
                const accuracy = appData.student.skills[state.currentGame].correct / appData.student.skills[state.currentGame].total;
                appData.student.skills[state.currentGame].mastery = Math.min(100, Math.floor(accuracy * 100));

                saveData(); // Save progress after correct answer

                // Only adjust difficulty if in auto mode
                const pref = appData.student.difficultyPreferences[state.currentGame];
                if (pref === 'auto') {
                    if (state.gameState.correctStreak >= 3 && state.gameState.difficulty === 'easy') {
                        state.gameState.difficulty = 'medium';
                    } else if (state.gameState.correctStreak >= 5 && state.gameState.difficulty === 'medium') {
                        state.gameState.difficulty = 'hard';
                    }
                }
                
                setTimeout(() => {
                    state.showHint = false;
                    state.gameState.question = generateProblem(state.currentGame, state.gameState.difficulty);
                    state.gameState.questionStart = Date.now();
                    render();
                }, 1000);
            } else {
                playSound('wrong');
                state.gameState.lives--;
                state.gameState.correctStreak = 0;
                state.gameState.mistakes.push({ question: state.gameState.question.question, correctAnswer: state.gameState.question.answer });
                
                // Only adjust difficulty if in auto mode
                const pref = appData.student.difficultyPreferences[state.currentGame];
                if (pref === 'auto') {
                    if (state.gameState.difficulty === 'hard') state.gameState.difficulty = 'medium';
                    else if (state.gameState.difficulty === 'medium') state.gameState.difficulty = 'easy';
                }
                
                appData.student.skills[state.currentGame].timeSpent += timeSpent;
                saveData(); // Save progress after wrong answer

                if (state.gameState.lives <= 0) {
                    endGame();
                } else {
                    setTimeout(() => {
                        state.showHint = false;
                        state.gameState.question = generateProblem(state.currentGame, state.gameState.difficulty);
                        state.gameState.questionStart = Date.now();
                        render();
                    }, 1500);
                }
            }
            render();
        }

        function endGame() {
            stopBackgroundMusic();
            playSound('complete');
            
            const sessionTime = Date.now() - state.gameState.sessionStart;
            const earnedStars = Math.floor(state.gameState.score / 20);
            const earnedXP = state.gameState.score * 2;
            
            appData.student.stars += earnedStars;
            appData.student.xp += earnedXP;
            appData.student.level = Math.floor(appData.student.xp / 100) + 1;
            
            appData.student.sessions.push({
                date: new Date().toISOString(),
                game: state.currentGame,
                score: state.gameState.score,
                correct: state.gameState.questionsAnswered,
                total: state.gameState.questionsAnswered + state.gameState.mistakes.length,
                time: sessionTime,
                mistakes: state.gameState.mistakes
            });
            
            saveData(); // Save session data
            state.screen = 'results';
            
            // Start menu music after game ends
            setTimeout(() => playBackgroundMusic('menu'), 500);
            
            render();
        }

        // Render Functions
        function renderHome() {
            const activities = [
                { id: 'addition', name: 'Number Bridge', icon: '‚ûï', color: 'linear-gradient(135deg, #98D8C8 0%, #67C7B3 100%)' },
                { id: 'subtraction', name: 'Treasure Hunt', icon: '‚ûñ', color: 'linear-gradient(135deg, #FFB6C1 0%, #FF9AA2 100%)' },
                { id: 'patterns', name: 'Pattern Quest', icon: 'üî¢', color: 'linear-gradient(135deg, #B4E5D4 0%, #98D8C8 100%)' },
                { id: 'placeValue', name: 'Castle Builder', icon: 'üè∞', color: 'linear-gradient(135deg, #FFD98E 0%, #FFB347 100%)' },
                { id: 'skipCount', name: 'Skip Count', icon: 'üéµ', color: 'linear-gradient(135deg, #E0BBE4 0%, #D291BC 100%)' },
                { id: 'storySolver', name: 'Story Solver', icon: 'üìñ', color: 'linear-gradient(135deg, #FFDAB9 0%, #FFB6C1 100%)' },
                { id: 'moneyMaster', name: 'Money Master', icon: 'üí∞', color: 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)' },
                { id: 'compareNumbers', name: 'Number Compare', icon: '‚öñÔ∏è', color: 'linear-gradient(135deg, #87CEEB 0%, #4682B4 100%)' }
            ];

            return `
                <div class="container">
                    <div class="card">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                <div style="font-size: 6rem;">${appData.student.avatar}</div>
                                <div>
                                    <h1>Hi ${appData.student.name}! üëã</h1>
                                    <div class="stat-badge mt-4">
                                        üëë Level ${appData.student.level}
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <div class="stat-badge" style="background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);">
                                    üí° ${appData.student.hintsAvailable}
                                </div>
                                <div class="stat-badge" style="background: linear-gradient(135deg, #FFD93D 0%, #FFB347 100%);">
                                    ‚≠ê ${appData.student.stars}
                                </div>
                                <button onclick="openSettings()" class="btn-round" style="background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);">
                                    ‚öôÔ∏è Settings
                                </button>
                                <button onclick="playSound('click'); state.screen='parentDashboard'; requestAdminCode();" class="btn-round btn-primary">
                                    üìä Parent
                                </button>
                            </div>
                        </div>
                        
                        <div style="margin-top: 2rem;">
                            <div class="flex justify-between mb-2">
                                <span style="font-weight: 700; color: #5A4A3A; font-size: 1.2rem;">Level Progress üöÄ</span>
                                <span style="font-weight: 800; color: #67C7B3; font-size: 1.2rem;">${appData.student.xp % 100}/100 XP</span>
                            </div>
                            <div class="progress-container">
                                <div class="progress-fill" style="width: ${appData.student.xp % 100}%;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="banner">
                        ‚ú® Choose Your Adventure! ‚ú®
                    </div>

                    <div class="grid grid-2">
                        ${activities.map(a => {
                            const skill = appData.student.skills[a.id];
                            return `
                                <div class="activity-tile" onclick="startGame('${a.id}')">
                                    <div class="activity-icon" style="background: ${a.color}; color: white;">
                                        ${a.icon}
                                    </div>
                                    <h3 class="text-center mb-4">${a.name}</h3>
                                    <div class="progress-container" style="height: 20px;">
                                        <div class="progress-fill" style="width: ${skill.mastery}%; background: ${a.color};"></div>
                                    </div>
                                    <p class="text-center mt-4" style="font-weight: 700; color: #67C7B3; font-size: 1.1rem;">
                                        ${skill.mastery}% Mastered
                                    </p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderPlaying() {
            const gs = state.gameState;
            const q = gs.question;
            
            let allAnswers;
            if (q.isSymbol) {
                allAnswers = [q.answer, ...q.wrongAnswers];
            } else {
                allAnswers = [q.answer, ...q.wrongAnswers].sort(() => Math.random() - 0.5);
            }

            return `
                <div class="container" style="padding-top: 2rem;">
                    <div class="banner" style="margin-bottom: 2rem;">
                        ${state.currentGame.charAt(0).toUpperCase() + state.currentGame.slice(1).replace(/([A-Z])/g, ' $1')}
                    </div>

                    <div class="card">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex gap-2">
                                ${Array(3).fill(0).map((_, i) => `<span style="font-size: 3rem;">${i < gs.lives ? '‚ù§Ô∏è' : 'üñ§'}</span>`).join('')}
                            </div>
                            <div class="flex gap-4">
                                <div class="stat-badge" style="background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);">üí° ${appData.student.hintsAvailable}</div>
                                <div class="stat-badge">üíØ ${gs.score}</div>
                                <div class="stat-badge" style="background: linear-gradient(135deg, #FFB347 0%, #FF8C42 100%);">
                                    üî• ${gs.correctStreak}
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div class="problem-card">
                                <div class="problem-text">${q.question}</div>
                                <div style="font-size: 5rem; margin-top: 2rem;">?</div>
                                
                                ${state.showHint ? `
                                    <div style="background: linear-gradient(135deg, #98D8C8 0%, #67C7B3 100%); color: white; padding: 1.5rem; border-radius: 20px; margin-top: 2rem; text-align: left;">
                                        <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">üí° Hint:</div>
                                        <div style="font-size: 1.3rem; margin-bottom: 1rem;">${q.hint}</div>
                                        ${q.visualHint ? `<div style="font-size: 1.6rem; font-weight: 700; background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 15px; text-align: center;">${q.visualHint}</div>` : ''}
                                    </div>
                                ` : ''}
                                
                                <button onclick="toggleHint()" class="help-btn" style="margin-top: 2rem;">
                                    ${state.showHint ? '‚úï' : '?'}
                                </button>
                            </div>

                            <div class="answer-grid">
                                ${allAnswers.map(ans => `
                                    <div class="answer-tile" onclick='checkAnswer(${q.isSymbol ? `"${ans}"` : ans})'>
                                        ${ans}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button onclick="playSound('click'); endGame()" class="btn-round btn-warning">
                            üè† End Game
                        </button>
                    </div>
                </div>
            `;
        }

        function renderResults() {
            const earnedStars = Math.floor(state.gameState.score / 20);
            const earnedXP = state.gameState.score * 2;
            
            return `
                <div class="container" style="padding-top: 2rem;">
                    <div class="card text-center">
                        <div class="character-big">üéâ</div>
                        <h1 class="mb-4">Amazing, ${appData.student.name}!</h1>
                        
                        <div class="grid grid-3 mb-6">
                            <div class="stat-badge" style="display: block; padding: 2rem;">
                                <div style="font-size: 3rem;">üíØ</div>
                                <div style="font-size: 2.5rem; margin: 1rem 0;">${state.gameState.score}</div>
                                <div style="font-size: 1rem;">Points</div>
                            </div>
                            <div class="stat-badge" style="display: block; padding: 2rem;">
                                <div style="font-size: 3rem;">‚úÖ</div>
                                <div style="font-size: 2.5rem; margin: 1rem 0;">${state.gameState.questionsAnswered}</div>
                                <div style="font-size: 1rem;">Correct</div>
                            </div>
                            <div class="stat-badge" style="display: block; padding: 2rem;">
                                <div style="font-size: 3rem;">‚≠ê</div>
                                <div style="font-size: 2.5rem; margin: 1rem 0;">+${earnedStars}</div>
                                <div style="font-size: 1rem;">Stars!</div>
                            </div>
                        </div>
                        
                        <div class="flex gap-4 justify-center">
                            <button onclick="playSound('click'); startGame('${state.currentGame}')" class="btn-round btn-success" style="font-size: 1.3rem;">
                                üöÄ Play Again
                            </button>
                            <button onclick="playSound('click'); state.screen='home'; render();" class="btn-round btn-primary" style="font-size: 1.3rem;">
                                üè† Home
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function openSettings() {
            playSound('click');
            const skillNames = {
                addition: 'Number Bridge',
                subtraction: 'Treasure Hunt',
                patterns: 'Pattern Quest',
                placeValue: 'Castle Builder',
                skipCount: 'Skip Count',
                storySolver: 'Story Solver',
                moneyMaster: 'Money Master',
                compareNumbers: 'Number Compare'
            };
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <h2 class="mb-4">‚öôÔ∏è Game Settings</h2>
                    
                    <!-- Sound Controls -->
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem; border: 3px solid #fbbf24;">
                        <h3 style="font-size: 1.3rem; margin-bottom: 1rem; color: #92400e;">üîä Sound & Music</h3>
                        <div class="flex gap-4" style="margin-bottom: 1rem;">
                            <button onclick="toggleSound()" class="btn-round ${state.soundEnabled ? 'btn-success' : ''}" style="flex: 1; padding: 1rem;">
                                ${state.soundEnabled ? 'üîä' : 'üîá'} Sound Effects
                            </button>
                            <button onclick="toggleMusic()" class="btn-round ${state.musicEnabled ? 'btn-primary' : ''}" style="flex: 1; padding: 1rem;">
                                ${state.musicEnabled ? 'üéµ' : 'üîï'} Music
                            </button>
                        </div>
                        <div style="background: white; padding: 1rem; border-radius: 12px;">
                            <label style="display: block; font-weight: 700; color: #92400e; margin-bottom: 0.5rem;">
                                üîâ Music Volume
                            </label>
                            <input type="range" min="0" max="100" value="${musicVolume * 100}" 
                                   onchange="setMusicVolume(this.value / 100)"
                                   style="width: 100%; accent-color: #f59e0b;" />
                        </div>
                    </div>
                    
                    <p style="color: #7A6A5A; font-size: 1.1rem; margin-bottom: 2rem;">
                        Choose difficulty level for each game. Select "Auto" to let the app adjust based on performance.
                    </p>
                    
                    <div style="max-height: 400px; overflow-y: auto; margin-bottom: 2rem;">
                        ${Object.keys(appData.student.difficultyPreferences).map(skill => `
                            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 15px; margin-bottom: 1rem;">
                                <h3 style="font-size: 1.3rem; margin-bottom: 1rem; color: #5A4A3A;">${skillNames[skill]}</h3>
                                <div class="flex gap-2">
                                    <button onclick="setDifficulty('${skill}', 'auto')" 
                                            id="diff-${skill}-auto"
                                            class="btn-round ${appData.student.difficultyPreferences[skill] === 'auto' ? 'btn-primary' : ''}" 
                                            style="flex: 1; padding: 0.8rem; font-size: 1rem;">
                                        ü§ñ Auto
                                    </button>
                                    <button onclick="setDifficulty('${skill}', 'easy')" 
                                            id="diff-${skill}-easy"
                                            class="btn-round ${appData.student.difficultyPreferences[skill] === 'easy' ? 'btn-success' : ''}" 
                                            style="flex: 1; padding: 0.8rem; font-size: 1rem;">
                                        üå± Easy
                                    </button>
                                    <button onclick="setDifficulty('${skill}', 'medium')" 
                                            id="diff-${skill}-medium"
                                            class="btn-round ${appData.student.difficultyPreferences[skill] === 'medium' ? 'btn-warning' : ''}" 
                                            style="flex: 1; padding: 0.8rem; font-size: 1rem; background: linear-gradient(135deg, #FFB347 0%, #FF8C42 100%);">
                                        üìö Medium
                                    </button>
                                    <button onclick="setDifficulty('${skill}', 'hard')" 
                                            id="diff-${skill}-hard"
                                            class="btn-round ${appData.student.difficultyPreferences[skill] === 'hard' ? 'btn-warning' : ''}" 
                                            style="flex: 1; padding: 0.8rem; font-size: 1rem; background: linear-gradient(135deg, #FF6B81 0%, #FF4757 100%);">
                                        üî• Hard
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #e0e7ff 0%, #ddd6fe 100%); padding: 1.5rem; border-radius: 15px; margin-bottom: 1.5rem;">
                        <div style="font-size: 1.2rem; font-weight: 700; color: #4338ca; margin-bottom: 0.5rem;">
                            üí° Hints Available: ${appData.student.hintsAvailable}
                        </div>
                        <p style="color: #6366f1; font-size: 0.95rem;">
                            Earn 1 hint for every 3 correct answers! üéØ
                        </p>
                    </div>
                    
                    <button onclick="closeSettingsModal()" class="btn-round btn-success" style="width: 100%;">
                        ‚úÖ Done
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function setDifficulty(skill, level) {
            playSound('click');
            appData.student.difficultyPreferences[skill] = level;
            saveData(); // Save difficulty preference
            
            // Update button styles
            ['auto', 'easy', 'medium', 'hard'].forEach(diff => {
                const btn = document.getElementById(`diff-${skill}-${diff}`);
                if (btn) {
                    btn.className = 'btn-round';
                    if (diff === level) {
                        if (diff === 'auto') btn.classList.add('btn-primary');
                        else if (diff === 'easy') btn.classList.add('btn-success');
                        else btn.classList.add('btn-warning');
                    }
                }
            });
        }

        function closeSettingsModal() {
            playSound('click');
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
        }

        // Export/Import Data Functions
        function exportData() {
            playSound('click');
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `smartv-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            playSound('complete');
            alert('Progress exported! üíæ Save this file to backup your data!');
        }

        function importData() {
            playSound('click');
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (importedData.student && importedData.adminCode) {
                            appData = importedData;
                            saveData();
                            state.screen = 'home';
                            render();
                            playSound('complete');
                            alert('Progress imported successfully! üéâ');
                        } else {
                            playSound('wrong');
                            alert('Invalid backup file! ‚ùå');
                        }
                    } catch (error) {
                        playSound('wrong');
                        alert('Error reading file! ‚ùå');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function requestAdminCode() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content text-center">
                    <h2 class="mb-4">üîê Parent Access</h2>
                    <p style="color: #7A6A5A; font-size: 1.2rem; margin-bottom: 2rem;">Enter 4-digit code</p>
                    <input type="password" id="codeInput" maxlength="4" 
                           style="width: 100%; text-align: center; font-size: 2.5rem; margin-bottom: 2rem; letter-spacing: 1rem;" 
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autofocus />
                    <div class="flex gap-4">
                        <button onclick="verifyCode()" class="btn-round btn-success" style="flex: 1;">‚úÖ Enter</button>
                        <button onclick="cancelModal()" class="btn-round btn-warning" style="flex: 1;">‚ùå Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function verifyCode() {
            const input = document.getElementById('codeInput').value;
            if (input === appData.adminCode) {
                playSound('correct');
                const modal = document.querySelector('.modal');
                if (modal) modal.remove();
                render();
            } else {
                playSound('wrong');
                alert('Wrong code! Try again üîí');
            }
        }

        function cancelModal() {
            playSound('click');
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
            state.screen = 'home';
            render();
        }

        function renderParentDashboard() {
            const student = appData.student;
            const skills = Object.entries(student.skills);
            const skillNames = {
                addition: 'Addition', subtraction: 'Subtraction', patterns: 'Patterns',
                placeValue: 'Place Value', skipCount: 'Skip Counting', storySolver: 'Story Problems',
                moneyMaster: 'Money & Coins', compareNumbers: 'Comparing Numbers'
            };

            const strongest = skills.reduce((a, b) => a[1].mastery > b[1].mastery ? a : b);
            const weakest = skills.reduce((a, b) => a[1].mastery < b[1].mastery ? a : b);
            const avgMastery = Math.round(skills.reduce((sum, [_, s]) => sum + s.mastery, 0) / skills.length);
            const totalTimeMinutes = Math.round(skills.reduce((sum, [_, s]) => sum + s.timeSpent, 0) / 60000);
            const recentSessions = appData.student.sessions.slice(-5).reverse();
            
            const lastFiveSessions = appData.student.sessions.slice(-5);
            const avgAccuracyRecent = lastFiveSessions.length > 0 
                ? Math.round(lastFiveSessions.reduce((sum, s) => sum + (s.correct / s.total * 100), 0) / lastFiveSessions.length)
                : 0;

            return `
                <div class="container" style="padding-top: 2rem;">
                    <div class="card">
                        <div class="flex justify-between items-center mb-6">
                            <h1>üìä ${student.name}'s Progress Report</h1>
                            <button onclick="playSound('click'); state.screen='home'; render();" class="btn-round btn-warning">üè† Home</button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 25px; margin-bottom: 2rem;">
                            <h2 style="color: white; margin-bottom: 1rem;">Overall Performance</h2>
                            <div class="grid grid-3">
                                <div style="text-align: center;">
                                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">üëë</div>
                                    <div style="font-size: 2.5rem; font-weight: 800;">Level ${student.level}</div>
                                    <div style="opacity: 0.9;">Current Level</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">‚≠ê</div>
                                    <div style="font-size: 2.5rem; font-weight: 800;">${student.stars}</div>
                                    <div style="opacity: 0.9;">Stars Earned</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">üìà</div>
                                    <div style="font-size: 2.5rem; font-weight: 800;">${avgMastery}%</div>
                                    <div style="opacity: 0.9;">Avg Mastery</div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-3 mb-6">
                            <div class="stat-badge" style="display: block; padding: 2rem; text-align: center; background: linear-gradient(135deg, #FFE5B4 0%, #FFD98E 100%);">
                                <div style="font-size: 2rem;">üìù</div>
                                <div style="font-size: 2rem; margin: 0.5rem 0; color: #5A4A3A;">${student.totalQuestionsAnswered}</div>
                                <div style="color: #7A6A5A;">Total Questions</div>
                            </div>
                            <div class="stat-badge" style="display: block; padding: 2rem; text-align: center; background: linear-gradient(135deg, #98D8C8 0%, #67C7B3 100%);">
                                <div style="font-size: 2rem;">‚úÖ</div>
                                <div style="font-size: 2rem; margin: 0.5rem 0; color: white;">${student.totalCorrect}</div>
                                <div style="color: white;">Correct Answers</div>
                            </div>
                            <div class="stat-badge" style="display: block; padding: 2rem; text-align: center; background: linear-gradient(135deg, #FFB6C1 0%, #FF9AA2 100%);">
                                <div style="font-size: 2rem;">üéØ</div>
                                <div style="font-size: 2rem; margin: 0.5rem 0; color: white;">
                                    ${student.totalQuestionsAnswered > 0 ? Math.round((student.totalCorrect / student.totalQuestionsAnswered) * 100) : 0}%
                                </div>
                                <div style="color: white;">Overall Accuracy</div>
                            </div>
                        </div>

                        <h2 class="mb-4">üìä Skill Analysis</h2>
                        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                            <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 2rem; border-radius: 25px; border: 4px solid #6ee7b7;">
                                <h3 style="color: #065f46; margin-bottom: 1rem; font-size: 1.5rem;">üí™ Strongest Skill</h3>
                                <div style="font-size: 2rem; font-weight: 800; color: #047857; margin-bottom: 0.5rem;">
                                    ${skillNames[strongest[0]]}
                                </div>
                                <div style="color: #065f46; font-size: 1.2rem; font-weight: 600;">
                                    ${strongest[1].mastery}% Mastery
                                </div>
                                <div style="color: #047857; margin-top: 1rem;">
                                    ‚ú® ${strongest[1].correct} out of ${strongest[1].total} correct!
                                </div>
                            </div>
                            <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 2rem; border-radius: 25px; border: 4px solid #fbbf24;">
                                <h3 style="color: #92400e; margin-bottom: 1rem; font-size: 1.5rem;">üìö Needs Practice</h3>
                                <div style="font-size: 2rem; font-weight: 800; color: #b45309; margin-bottom: 0.5rem;">
                                    ${skillNames[weakest[0]]}
                                </div>
                                <div style="color: #92400e; font-size: 1.2rem; font-weight: 600;">
                                    ${weakest[1].mastery}% Mastery
                                </div>
                                <div style="color: #b45309; margin-top: 1rem;">
                                    üí° Practice this skill more!
                                </div>
                            </div>
                        </div>

                        <h2 class="mb-4">üìà Detailed Skill Progress</h2>
                        ${skills.map(([skill, data]) => {
                            const accuracy = data.total > 0 ? Math.round((data.correct / data.total) * 100) : 0;
                            const status = data.mastery >= 70 ? { emoji: 'üåü', text: 'Mastered!', color: '#10b981' } :
                                          data.mastery >= 40 ? { emoji: 'üìö', text: 'Learning', color: '#f59e0b' } :
                                          { emoji: 'üå±', text: 'Beginner', color: '#6b7280' };
                            const avgTime = data.total > 0 ? Math.round(data.timeSpent / data.total / 1000) : 0;
                            
                            return `
                                <div style="background: white; border-radius: 20px; padding: 2rem; margin-bottom: 1.5rem; border: 3px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                                    <div class="flex justify-between items-center mb-3">
                                        <div>
                                            <h3 style="font-size: 1.5rem; color: #2d3748;">${skillNames[skill]}</h3>
                                            <div style="color: ${status.color}; font-weight: 700; margin-top: 0.25rem;">
                                                ${status.emoji} ${status.text}
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 2.5rem; font-weight: 800; color: ${status.color};">
                                                ${data.mastery}%
                                            </div>
                                            <div style="color: #64748b; font-size: 0.9rem;">Mastery</div>
                                        </div>
                                    </div>
                                    
                                    <div class="progress-container" style="height: 20px; margin-bottom: 1rem;">
                                        <div class="progress-fill" style="width: ${data.mastery}%; background: linear-gradient(90deg, ${status.color}, ${status.color}dd);"></div>
                                    </div>
                                    
                                    <div class="grid grid-3" style="gap: 1rem;">
                                        <div style="background: #f8fafc; padding: 1rem; border-radius: 12px; text-align: center;">
                                            <div style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.25rem;">Questions</div>
                                            <div style="font-size: 1.5rem; font-weight: 700; color: #2d3748;">${data.total}</div>
                                        </div>
                                        <div style="background: #f8fafc; padding: 1rem; border-radius: 12px; text-align: center;">
                                            <div style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.25rem;">Accuracy</div>
                                            <div style="font-size: 1.5rem; font-weight: 700; color: #2d3748;">${accuracy}%</div>
                                        </div>
                                        <div style="background: #f8fafc; padding: 1rem; border-radius: 12px; text-align: center;">
                                            <div style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.25rem;">Avg Time</div>
                                            <div style="font-size: 1.5rem; font-weight: 700; color: #2d3748;">${avgTime}s</div>
                                        </div>
                                    </div>
                                    
                                    ${data.mastery < 30 ? `
                                        <div style="background: #fef3f2; padding: 1rem; border-radius: 12px; margin-top: 1rem; border-left: 4px solid #ef4444;">
                                            <strong style="color: #dc2626;">üí™ Recommendation:</strong>
                                            <span style="color: #991b1b;"> Practice 10-15 minutes daily with this skill</span>
                                        </div>
                                    ` : data.mastery < 70 ? `
                                        <div style="background: #fef9e6; padding: 1rem; border-radius: 12px; margin-top: 1rem; border-left: 4px solid #f59e0b;">
                                            <strong style="color: #d97706;">üìö Keep Going:</strong>
                                            <span style="color: #92400e;"> Great progress! Continue practicing regularly</span>
                                        </div>
                                    ` : `
                                        <div style="background: #d1fae5; padding: 1rem; border-radius: 12px; margin-top: 1rem; border-left: 4px solid #10b981;">
                                            <strong style="color: #059669;">üåü Excellent:</strong>
                                            <span style="color: #065f46;"> Mastered! Ready for harder challenges</span>
                                        </div>
                                    `}
                                </div>
                            `;
                        }).join('')}

                        ${recentSessions.length > 0 ? `
                            <h2 class="mb-4">üìÖ Recent Learning Sessions</h2>
                            <div style="background: #f8fafc; padding: 2rem; border-radius: 20px; margin-bottom: 2rem;">
                                ${recentSessions.map(session => {
                                    const date = new Date(session.date);
                                    const accuracy = Math.round((session.correct / session.total) * 100);
                                    return `
                                        <div style="background: white; padding: 1.5rem; border-radius: 15px; margin-bottom: 1rem; border: 2px solid #e2e8f0;">
                                            <div class="flex justify-between items-center">
                                                <div>
                                                    <h4 style="font-size: 1.2rem; color: #2d3748; font-weight: 700;">
                                                        ${skillNames[session.game]}
                                                    </h4>
                                                    <div style="color: #64748b; margin-top: 0.25rem;">
                                                        ${date.toLocaleDateString()} at ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                                    </div>
                                                </div>
                                                <div style="display: flex; gap: 1rem;">
                                                    <div style="text-align: center;">
                                                        <div style="font-size: 1.5rem; font-weight: 800; color: #667eea;">
                                                            ${session.score}
                                                        </div>
                                                        <div style="color: #64748b; font-size: 0.85rem;">Score</div>
                                                    </div>
                                                    <div style="text-align: center;">
                                                        <div style="font-size: 1.5rem; font-weight: 800; color: ${accuracy >= 70 ? '#10b981' : accuracy >= 50 ? '#f59e0b' : '#ef4444'};">
                                                            ${session.correct}/${session.total}
                                                        </div>
                                                        <div style="color: #64748b; font-size: 0.85rem;">${accuracy}%</div>
                                                    </div>
                                                    <div style="text-align: center;">
                                                        <div style="font-size: 1.5rem; font-weight: 800; color: #6366f1;">
                                                            ${Math.round(session.time / 60000)}m
                                                        </div>
                                                        <div style="color: #64748b; font-size: 0.85rem;">Time</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : `
                            <div style="background: #f8fafc; padding: 3rem; border-radius: 20px; text-align: center; margin-bottom: 2rem;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">üìä</div>
                                <h3 style="color: #64748b; margin-bottom: 0.5rem;">No sessions yet</h3>
                                <p style="color: #94a3b8;">Start playing to see progress here!</p>
                            </div>
                        `}

                        <h2 class="mb-4">üí° Insights & Recommendations</h2>
                        <div style="background: linear-gradient(135deg, #e0e7ff 0%, #ddd6fe 100%); padding: 2rem; border-radius: 25px; margin-bottom: 2rem; border: 4px solid #a5b4fc;">
                            <h3 style="color: #4338ca; margin-bottom: 1.5rem; font-size: 1.5rem;">For ${student.name}'s Parents</h3>
                            
                            <div style="background: white; padding: 1.5rem; border-radius: 15px; margin-bottom: 1rem;">
                                <strong style="color: #4f46e5;">üìä Learning Pattern:</strong>
                                <p style="color: #4b5563; margin-top: 0.5rem; line-height: 1.6;">
                                    ${student.totalQuestionsAnswered < 20 
                                        ? `${student.name} is just getting started! Encourage daily practice for best results.`
                                        : avgAccuracyRecent >= 80 
                                        ? `${student.name} is doing excellent! Consider introducing more challenging problems.`
                                        : avgAccuracyRecent >= 60
                                        ? `${student.name} is making steady progress. Continue consistent practice.`
                                        : `${student.name} may benefit from extra support. Try reviewing concepts together.`
                                    }
                                </p>
                            </div>
                            
                            <div style="background: white; padding: 1.5rem; border-radius: 15px; margin-bottom: 1rem;">
                                <strong style="color: #4f46e5;">‚è∞ Practice Schedule:</strong>
                                <p style="color: #4b5563; margin-top: 0.5rem; line-height: 1.6;">
                                    ${totalTimeMinutes < 30
                                        ? `Aim for 15-20 minutes daily (currently ${totalTimeMinutes} minutes total)`
                                        : totalTimeMinutes < 100
                                        ? `Great! Keep up the daily practice routine (${totalTimeMinutes} minutes total)`
                                        : `Excellent practice time! (${totalTimeMinutes} minutes total)`
                                    }
                                </p>
                            </div>
                            
                            <div style="background: white; padding: 1.5rem; border-radius: 15px;">
                                <strong style="color: #4f46e5;">üéØ Focus Areas:</strong>
                                <ul style="color: #4b5563; margin-top: 0.5rem; line-height: 1.8; padding-left: 1.5rem;">
                                    ${weakest[1].mastery < 50 ? `<li>Prioritize <strong>${skillNames[weakest[0]]}</strong> practice</li>` : ''}
                                    <li>Celebrate mistakes as learning opportunities</li>
                                    <li>Use the hint button (?) to develop problem-solving strategies</li>
                                    <li>Review incorrect answers together</li>
                                    ${strongest[1].mastery >= 80 ? `<li><strong>${skillNames[strongest[0]]}</strong> is mastered - great work!</li>` : ''}
                                </ul>
                            </div>
                        </div>

                        <div style="background: linear-gradient(135deg, #FFE5E5 0%, #FFD0D0 100%); padding: 2rem; border-radius: 25px; text-align: center; border: 4px solid rgba(255, 255, 255, 0.5); margin-bottom: 2rem;">
                            <h3 style="color: #CC5555; margin-bottom: 1rem; font-size: 1.5rem;">üíæ Backup & Restore</h3>
                            <p style="color: #AA4444; margin-bottom: 1.5rem; font-size: 1rem;">
                                Save your progress to a file or restore from a backup
                            </p>
                            <div class="flex gap-4">
                                <button onclick="exportData()" class="btn-round btn-primary" style="flex: 1; font-size: 1.1rem;">
                                    üì• Export Backup
                                </button>
                                <button onclick="importData()" class="btn-round btn-success" style="flex: 1; font-size: 1.1rem;">
                                    üì§ Import Backup
                                </button>
                            </div>
                        </div>

                        <div style="background: linear-gradient(135deg, #FFE5E5 0%, #FFD0D0 100%); padding: 2rem; border-radius: 25px; text-align: center; border: 4px solid rgba(255, 255, 255, 0.5);">
                            <h3 style="color: #CC5555; margin-bottom: 1rem; font-size: 1.5rem;">‚ö†Ô∏è Reset All Progress</h3>
                            <p style="color: #AA4444; margin-bottom: 1.5rem; font-size: 1.1rem;">
                                This will delete all stars, XP, and progress. ${student.name} will start fresh!
                            </p>
                            <button onclick="resetProgress()" class="btn-round btn-warning" style="background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%); font-size: 1.2rem;">
                                üîÑ Reset Everything
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            const screens = {
                setup: renderSetup,
                home: renderHome,
                playing: renderPlaying,
                results: renderResults,
                parentDashboard: renderParentDashboard
            };
            document.getElementById('app').innerHTML = screens[state.screen]();
            
            // Auto-start menu music on non-game screens
            if (state.screen !== 'playing' && state.musicEnabled && !currentMusic) {
                setTimeout(() => playBackgroundMusic('menu'), 100);
            }
        }

        // Start menu music on initial load
        setTimeout(() => {
            if (state.screen !== 'playing' && state.musicEnabled) {
                playBackgroundMusic('menu');
            }
        }, 500);

        render();
    </script>
</body>
</html>
